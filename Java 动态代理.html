<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="不断提高自己认知，不断的为自己想要的努力"><title>动态代理 | fuchenxuan’ blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="/weixin.js"></script><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">动态代理</h1><a id="logo" href="/.">fuchenxuan’ blog</a><p class="description">不断提高自己认知，不断的为自己想要的努力</p></div><div id="nav-menu"><a href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/message/"><i class="fa fa-comments"> 留言</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">动态代理</h1><div class="post-content"><h3 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h3><h4 id="一、-动态代理实现方式"><a href="#一、-动态代理实现方式" class="headerlink" title="一、 动态代理实现方式"></a>一、 动态代理实现方式</h4><p>Java中的动态代理给我们提供一种动态生成类的方式，有很好的灵活性，这种技术一般会出现在一些第三方框架中，来降低接入方的使用成本。以下为常用的实现动态代理的几种方式：</p>
<ol>
<li><p>JDK自带的Proxy方式</p>
<p>优点：JDK亲儿子；无依赖；使用简单</p>
<p>缺点：代理类必须继承至少一个接口；无法继承已有父类</p>
</li>
<li><p>asm方式，基于class字节码的操作</p>
<p>优点：很底层到操作，性能高，对性能要求苛刻的建议使用</p>
<p>​缺点：使用成本高，要熟悉JVM汇编指令</p>
</li>
<li><p>javassist方式，基于class字节码的操作</p>
<p>优点：Api简单，通熟易懂，使用成本低</p>
<p>缺点：性能相对偏低</p>
</li>
<li><p>cglib方式，这个是基于ASM的</p>
<p>​优点：Api简单；高性能；高灵活性；支持继承父类；可以不用实现接口</p>
<p>缺点：这个真的很强大，个人感觉比JDK自带的要强大很多，一定要说的话只能说使用这个需要加jar包依赖</p>
</li>
</ol>
<h4 id="二、业务开发的尴尬"><a href="#二、业务开发的尴尬" class="headerlink" title="二、业务开发的尴尬"></a>二、业务开发的尴尬</h4><p>开门见山，我们直接来看一个业务场景：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.puke.net;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> zijiao</div><div class="line"> * <span class="doctag">@version</span> 16/8/19</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> String username;</div><div class="line">    <span class="keyword">public</span> String uId;</div><div class="line">    <span class="keyword">public</span> String sex;</div><div class="line">    <span class="keyword">public</span> String address;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"User&#123;"</span> +</div><div class="line">                <span class="string">"username='"</span> + username + <span class="string">'\''</span> +</div><div class="line">                <span class="string">", uId='"</span> + uId + <span class="string">'\''</span> +</div><div class="line">                <span class="string">", sex='"</span> + sex + <span class="string">'\''</span> +</div><div class="line">                <span class="string">", address='"</span> + address + <span class="string">'\''</span> +</div><div class="line">                <span class="string">'&#125;'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里就是一个用户信息的Entity类，不解释了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.puke.net;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.google.gson.Gson;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> zijiao</div><div class="line"> * <span class="doctag">@version</span> 16/8/19</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VirtualHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Gson sGson = <span class="keyword">new</span> Gson();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">request</span><span class="params">(String url, Map&lt;String, Object&gt; params)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (params != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="string">"123"</span>.equals(params.get(<span class="string">"username"</span>))</div><div class="line">                    &amp;&amp; <span class="string">"456"</span>.equals(params.get(<span class="string">"password"</span>))) &#123;</div><div class="line">                User user = <span class="keyword">new</span> User();</div><div class="line">                user.address = <span class="string">"杭州"</span>;</div><div class="line">                user.sex = <span class="string">"男"</span>;</div><div class="line">                user.uId = <span class="string">"Id"</span>;</div><div class="line">                user.username = <span class="string">"啊啊"</span>;</div><div class="line">                <span class="keyword">return</span> sGson.toJson(user);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里我们模拟一个简单的网络请求。</p>
<p>当我们业务场景需要调用网络请求执行登录操作的时候，会这样写：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.puke.net;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.google.gson.Gson;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> zijiao</div><div class="line"> * <span class="doctag">@version</span> 16/8/19</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserApi</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String API_LOGIN = <span class="string">"http://***.***.***"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Gson sGson = <span class="keyword">new</span> Gson();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> User <span class="title">login</span><span class="params">(String username, String password)</span> </span>&#123;</div><div class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        params.put(<span class="string">"username"</span>, username);</div><div class="line">        params.put(<span class="string">"password"</span>, password);</div><div class="line">        String response = VirtualHelper.request(API_LOGIN, params);</div><div class="line">        <span class="comment">//注，这里只是为了举例说明一下，就假设此时的数据结构就是跟User一致的</span></div><div class="line">        <span class="keyword">return</span> sGson.fromJson(response, User.class);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>那么，有什么问题呢。其实如果只是一个单单的login方法很难直观的反馈出来问题所在，很多时候我们为了去验证一个事物的合理性我们不妨去开始极端遐想一下这种情况：现在UserApi中又多了register方法，query方法，getToken方法，validate方法……甚至接下来一个UserApi已经满足不了我们了，我们开始有GoodsApi，OrderApi，MessageApi等等等等，试想一下N个Api的类，每个Api类都有N个类似于上面login的这种方法，而实际情况下我们request的入参还远远不止username，password两个这么简单。当我们业务场景扩大的时候，这些都是我们势必要面对的。这是一个问题，那能不能去以一种更优雅的方式去解决从而简化业务方的代码量并且降低使用成本呢。这里便引入了我们的动态代理~</p>
<h4 id="三、-动态代理的方式去解决"><a href="#三、-动态代理的方式去解决" class="headerlink" title="三、 动态代理的方式去解决"></a>三、 动态代理的方式去解决</h4><p>我们的目标是状态是这样的：让业务方写写接口，加加注解配置，就可以直接使用</p>
<h5 id="1-先定义两个支持配置的注解"><a href="#1-先定义两个支持配置的注解" class="headerlink" title="1. 先定义两个支持配置的注解"></a>1. 先定义两个支持配置的注解</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.puke.net.proxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.Inherited;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.Target;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> zijiao</div><div class="line"> * <span class="doctag">@version</span> 16/8/19</div><div class="line"> */</div><div class="line"><span class="meta">@Inherited</span></div><div class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> URL &#123;</div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.puke.net.proxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.Inherited;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.Target;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> zijiao</div><div class="line"> * <span class="doctag">@version</span> 16/8/19</div><div class="line"> */</div><div class="line"><span class="meta">@Inherited</span></div><div class="line"><span class="meta">@Target</span>(ElementType.PARAMETER)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="meta">@interface</span> Param &#123;</div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里不过多说明，就是两个可配字符串的注解。</p>
<h5 id="2-定义一套接口"><a href="#2-定义一套接口" class="headerlink" title="2. 定义一套接口"></a>2. 定义一套接口</h5><p>这一步，其实不是必需的。我们完全可以在动态代理中直接显式的调用VirtualHelper类，但既然抽象出来网络Api这块，那就干脆定义一套接口出来来解耦具体实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.puke.net.proxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> zijiao</div><div class="line"> * <span class="doctag">@version</span> 16/8/19</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IRequest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function">String <span class="title">url</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function">Map&lt;String, Object&gt; <span class="title">params</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    Class&lt;?&gt; responseCls();</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.puke.net.proxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> zijiao</div><div class="line"> * <span class="doctag">@version</span> 16/8/19</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Request</span> <span class="keyword">implements</span> <span class="title">IRequest</span> </span>&#123;</div><div class="line"></div><div class="line">    String url;</div><div class="line">    Map&lt;String, Object&gt; params;</div><div class="line">    Class&lt;?&gt; responseCls;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Request</span><span class="params">(String url, Map&lt;String, Object&gt; params, Class&lt;?&gt; responseCls)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.url = url;</div><div class="line">        <span class="keyword">this</span>.params = params;</div><div class="line">        <span class="keyword">this</span>.responseCls = responseCls;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">url</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> url;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">params</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> params;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Class&lt;?&gt; responseCls() &#123;</div><div class="line">        <span class="keyword">return</span> responseCls;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这是请求接口和实现类，粗略写下，比较简单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.puke.net.proxy;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> zijiao</div><div class="line"> * <span class="doctag">@version</span> 16/8/19</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">INetExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(IRequest request)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.puke.net.proxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.google.gson.Gson;</div><div class="line"><span class="keyword">import</span> com.puke.net.VirtualHelper;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> zijiao</div><div class="line"> * <span class="doctag">@version</span> 16/8/19</div><div class="line"> */</div><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultNetExecutor</span> <span class="keyword">implements</span> <span class="title">INetExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Gson sGson = <span class="keyword">new</span> Gson();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(IRequest request)</span> </span>&#123;</div><div class="line">        String response = VirtualHelper.request(request.url(), request.params());</div><div class="line">        <span class="keyword">return</span> (T) sGson.fromJson(response, request.responseCls());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个是网络执行器已经默认的实现方式（使用上面的VirtualHelper），主要是抽象出接口可以让业务方自主定制真正的执行操作。</p>
<h5 id="3-动态代理器"><a href="#3-动态代理器" class="headerlink" title="3. 动态代理器"></a>3. 动态代理器</h5><p>这个就直接上代码了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.puke.net.proxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.text.TextUtils;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> zijiao</div><div class="line"> * <span class="doctag">@version</span> 16/8/19</div><div class="line"> */</div><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiGenerator</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class, Object&gt; sApiCache = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> INetExecutor sNetExecutor;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Handler</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> Class&lt;T&gt; apiInterface;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Class&lt;T&gt; apiInterface)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.apiInterface = apiInterface;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">            IRequest request = resolveRequest(method, args, apiInterface);</div><div class="line">            <span class="keyword">if</span> (sNetExecutor == <span class="keyword">null</span>) &#123;</div><div class="line">                sNetExecutor = defaultNetExecutor();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> sNetExecutor.execute(request);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">IRequest <span class="title">resolveRequest</span><span class="params">(Method method, Object[] args, Class&lt;T&gt; apiInterface)</span> </span>&#123;</div><div class="line">        StringBuilder urlBuilder = <span class="keyword">new</span> StringBuilder();</div><div class="line">        Map&lt;String, Object&gt; params = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (apiInterface.isAnnotationPresent(URL.class)) &#123;</div><div class="line">            String baseUrl = apiInterface.getAnnotation(URL.class).value();</div><div class="line">            <span class="keyword">if</span> (!TextUtils.isEmpty(baseUrl)) &#123;</div><div class="line">                urlBuilder.append(baseUrl);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (method.isAnnotationPresent(URL.class)) &#123;</div><div class="line">            String subUrl = method.getAnnotation(URL.class).value();</div><div class="line">            <span class="keyword">if</span> (!TextUtils.isEmpty(subUrl)) &#123;</div><div class="line">                urlBuilder.append(subUrl);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (Annotation[] annotations : method.getParameterAnnotations()) &#123;</div><div class="line">            <span class="keyword">for</span> (Annotation annotation : annotations) &#123;</div><div class="line">                <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> Param) &#123;</div><div class="line">                    String key = ((Param) annotation).value();</div><div class="line">                    <span class="keyword">if</span> (!TextUtils.isEmpty(key)) &#123;</div><div class="line">                        <span class="keyword">if</span> (params == <span class="keyword">null</span>) &#123;</div><div class="line">                            params = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">                        &#125;</div><div class="line">                        params.put(key, args[index]);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            index++;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Request(urlBuilder.toString(), params, method.getReturnType());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> INetExecutor <span class="title">defaultNetExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultNetExecutor();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">generateApi</span><span class="params">(Class&lt;T&gt; apiInterface)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (apiInterface == <span class="keyword">null</span> || !apiInterface.isInterface()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"the apiInterface is null or isn`t interface."</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">synchronized</span> (ApiGenerator.class) &#123;</div><div class="line">            Object api = sApiCache.get(apiInterface);</div><div class="line">            <span class="keyword">if</span> (api == <span class="keyword">null</span>) &#123;</div><div class="line">                api = Proxy.newProxyInstance(apiInterface.getClassLoader(),</div><div class="line">                        <span class="keyword">new</span> Class[]&#123;apiInterface&#125;,</div><div class="line">                        <span class="keyword">new</span> Handler(apiInterface));</div><div class="line">                sApiCache.put(apiInterface, api);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> (T) api;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 外部提供自定义执行器</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> netExecutor 网络执行器</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setNetExecutor</span><span class="params">(INetExecutor netExecutor)</span> </span>&#123;</div><div class="line">        sNetExecutor = netExecutor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>到此，我们的动态代理的编码部分就结束了。我们可以看一下ApiGenerator这个类有个sApiCache的静态变量，他缓存了动态代理生成的对象，这里这样做还是很有必要的，防止重复创建Api的代理类造成额外的性能消耗。</p>
<h5 id="4-使用姿势"><a href="#4-使用姿势" class="headerlink" title="4. 使用姿势"></a>4. 使用姿势</h5><p>业务方只需要按照我们约束的一套标准来写一个interface即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.puke.dynamicproxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.puke.net.User;</div><div class="line"><span class="keyword">import</span> com.puke.net.proxy.Param;</div><div class="line"><span class="keyword">import</span> com.puke.net.proxy.URL;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> zijiao</div><div class="line"> * <span class="doctag">@version</span> 16/8/19</div><div class="line"> */</div><div class="line"><span class="meta">@URL</span>(<span class="string">"http://***.***.***"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LoginApi</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function">User <span class="title">login</span><span class="params">(@Param(<span class="string">"username"</span>)</span> String username,</span></div><div class="line">               @<span class="title">Param</span><span class="params">(<span class="string">"password"</span>)</span> String password);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个是业务方要写的接口，以及对应的一些注解配置。</p>
<p>接下来就可以直接使用LoginApi生成的具体实例了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.puke.dynamicproxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.app.Activity;</div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"><span class="keyword">import</span> android.view.View;</div><div class="line"><span class="keyword">import</span> android.widget.Toast;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.puke.net.User;</div><div class="line"><span class="keyword">import</span> com.puke.net.proxy.ApiGenerator;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        findViewById(R.id.login).setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                LoginApi loginApi = ApiGenerator.generateApi(LoginApi.class);</div><div class="line">                User user = loginApi.login(<span class="string">"123"</span>, <span class="string">"456"</span>);</div><div class="line">                Toast.makeText(MainActivity.<span class="keyword">this</span>, user.toString(), Toast.LENGTH_SHORT).show();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于此处模拟的网络请求，就不考虑主线程的进行这个操作了。</p>
<h5 id="5-使用对比"><a href="#5-使用对比" class="headerlink" title="5. 使用对比"></a>5. 使用对比</h5><p>这里我再贴一下两种使用前后的代码对比</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserApi</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String API_LOGIN = <span class="string">"http://***.***.***"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Gson sGson = <span class="keyword">new</span> Gson();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> User <span class="title">login</span><span class="params">(String username, String password)</span> </span>&#123;</div><div class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        params.put(<span class="string">"username"</span>, username);</div><div class="line">        params.put(<span class="string">"password"</span>, password);</div><div class="line">        String response = VirtualHelper.request(API_LOGIN, params);</div><div class="line">        <span class="comment">//注，这里只是为了举例说明一下，就假设此时的数据结构就是跟User一致的</span></div><div class="line">        <span class="keyword">return</span> sGson.fromJson(response, User.class);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个是传统的Api方式下业务方要写的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@URL</span>(<span class="string">"http://***.***.***"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LoginApi</span> </span>&#123;</div><div class="line">    <span class="function">User <span class="title">login</span><span class="params">(@Param(<span class="string">"username"</span>)</span> String username,</span></div><div class="line">               @<span class="title">Param</span><span class="params">(<span class="string">"password"</span>)</span> String password);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个是使用了动态代理之后业务方要写的代码</p>
<p>对比一下，明显能感觉到我们的代码精简了一大圈，看上去清晰明了~</p>
<p>这里我们再回归到最近开始提到的问题，当业务逐渐扩大的时候，这两种模式下，无论是开发效率上还是代码精简度上根本不具有可比性。</p>
<h4 id="四、-一些想法"><a href="#四、-一些想法" class="headerlink" title="四、 一些想法"></a>四、 一些想法</h4><p>其实，基于动态代理我们还可以做很多事情，当某一类事物有一些共性，我们一直重复去写一堆“孪生”代码，不仅降低了我们的开发效率，还容易让我产生一种思维定式，按照一个固有的模式去重复做一类事太容易固化我们的思维。不仅仅是动态代理，还有很多很多，开发本该是件轻松的事。工欲善其事，必先利其器。</p>
</div></div><div id="disqus_thread"><script>var disqus_shortname = 'fushenghua';
var disqus_identifier = 'Java 动态代理.html';
var disqus_title = '动态代理';
var disqus_url = 'http://fushenghua.github.io/Java 动态代理.html';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//fushenghua.disqus.com/count.js" async></script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://fushenghua.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/基础技能/">基础技能</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/性能优化/">性能优化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/源码/">源码</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/优化/" style="font-size: 15px;">优化</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/archives/c9281ba6.html">OkHttp 的理解</a></li><li class="post-list-item"><a class="post-list-link" href="/archives/1dde1414.html">Android中的设计模式</a></li><li class="post-list-item"><a class="post-list-link" href="/archives/3e3728fd.html">为什么说枚举更占内存，枚举原理是什么？</a></li><li class="post-list-item"><a class="post-list-link" href="/archives/ed6915f6.html">在Pypi上发布自己的Python包</a></li><li class="post-list-item"><a class="post-list-link" href="/archives/59f7e7f7.html">调试 ART 垃圾回收</a></li><li class="post-list-item"><a class="post-list-link" href="/archives/59f7e7f7.html">配置ART</a></li><li class="post-list-item"><a class="post-list-link" href="/archives/af68deab.html">INSTALL_FAILED_TEST_ONLY的原因</a></li><li class="post-list-item"><a class="post-list-link" href="/archives/3dbdbf17.html">实现 ART 即时 (JIT) 编译器</a></li><li class="post-list-item"><a class="post-list-link" href="/archives/3b12125.html">Android 8.0 中的 ART 功能改进</a></li><li class="post-list-item"><a class="post-list-link" href="/archives/a9cc5307.html">ART 和 Dalvik的区别</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//fushenghua.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">fuchenxuan’ blog</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/weixin.js"></script><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>